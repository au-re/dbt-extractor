<!DOCTYPE html>

<html>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <h1>dbt Tree-Sitter Demo</h1>

        <div class="flex-container">
            <label for="w3review">dbt Model File</label>
            <textarea id="model" name="model" rows="4" cols="50" autofocus=autofocus>
            </textarea>
            <text id="time"></text>
            <text id="error"></text>
            <text id="refs"></text>
            <text id="sources"></text>
            <text id="configs"></text>
        </div>
    </body>
</html>

<script>
    model = document.getElementById("model")
    model.addEventListener("keyup", function() {
        // Backspace
        if (event.keyCode == 8) {
            dbtExtract(model.value)
        }
        // Delete.
        else if (event.keyCode == 46) {
            dbtExtract(model.value)
        }
        else {
            dbtExtract(model.value)
        }
    })

    function dbtExtract(text) {
        console.log(JSON.stringify(text))
        fetch("http://127.0.0.1:8000/", {
            method: "POST", 
            body: JSON.stringify(text)
        }).then(res => {
            return res.json()
        }).then(res => {
            console.log(res);
            document.getElementById("time").innerHTML = 
                "-- completed in " + (res.ms) + " ms --"
            document.getElementById("error").innerHTML = 
                "Error:   " + res.error
            document.getElementById("refs").innerHTML = 
                "Refs:    " + res.refs
            document.getElementById("sources").innerHTML = 
                "Sources: " + res.sources
            document.getElementById("configs").innerHTML = 
                "Configs: " + res.configs
        }).catch((error) => {
            console.error(error);
        });
    }
</script>